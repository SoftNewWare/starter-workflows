name: Update Confluence on PR Merge

on:
  pull_request:
    types:
      - closed  # Runs only when a PR is merged
    branches:
      - main  # Change this if your main branch has a different name

jobs:
  update-confluence:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetches full history to get commit logs correctly

      - name: Fetch Commit Details
        run: |
          MODULE_NAME=$(basename $GITHUB_REPOSITORY)  # Extracts repo name
          echo "Module Name: $MODULE_NAME"

          # Start table structure
          echo '<table><tr><th>Module Name</th><th>Commit ID</th><th>Commit Message</th><th>Commit Date & Time</th></tr>' > table.html

          # Fetch commit details from PR range
          git log --pretty=format:"%H|%s|%cd" --date=iso ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > commits.txt

          while IFS='|' read -r COMMIT_ID COMMIT_MSG COMMIT_DATE; do
            echo "Adding commit: $COMMIT_ID - $COMMIT_MSG - $COMMIT_DATE"
            echo "<tr><td>$MODULE_NAME</td><td>$COMMIT_ID</td><td>$COMMIT_MSG</td><td>$COMMIT_DATE</td></tr>" >> table.html
          done < commits.txt

          # End table
          echo '</table>' >> table.html

          # Debug: Show final table content
          echo "Final table content:"
          cat table.html

      - name: Fetch Current Confluence Page Version
        id: get_page
        run: |
          PAGE_ID="98308"
          CONFLUENCE_URL="https://airnewn.atlassian.net/wiki"

          echo "üîç Checking authentication..."
          
          RESPONSE=$(curl -s -X GET "$CONFLUENCE_URL/rest/api/content/$PAGE_ID?expand=version" \
            -u "${{ secrets.CONFLUENCE_USERNAME }}:${{ secrets.CONFLUENCE_API_TOKEN }}" \
            -H "Accept: application/json")

          echo "API Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q "Unauthorized"; then
            echo "‚ùå Authentication failed! Check your API token and username."
            exit 1
          fi

          PAGE_VERSION=$(echo "$RESPONSE" | jq -r '.version.number // 1')
          echo "Current Page Version: $PAGE_VERSION"

          echo "PAGE_VERSION=$PAGE_VERSION" >> $GITHUB_ENV

      - name: Debug JSON Payload
        run: |
          PAGE_ID="98308"
          CONFLUENCE_URL="https://airnewn.atlassian.net/wiki"
          PAGE_VERSION="3"  # Example version, replace dynamically if needed

          JSON_PAYLOAD=$(cat <<EOF
          {
            "id": "$PAGE_ID",
            "type": "page",
            "title": "Your Page Title",
            "space": { "key": "YOUR_SPACE_KEY" },
            "version": { "number": $((PAGE_VERSION + 1)) },
            "body": {
              "storage": {
                "value": "<table><tr><th>Module Name</th><th>Commit ID</th><th>Commit Message</th><th>Commit Date & Time</th></tr><tr><td>TestModule</td><td>1234567</td><td>Fix bug</td><td>2025-04-02</td></tr></table>",
                "representation": "storage"
              }
            }
          }
          EOF
          )

          echo "üìù JSON PAYLOAD:"
          echo "$JSON_PAYLOAD"

      - name: Update Confluence Page
        run: |
          PAGE_ID="98308"
          CONFLUENCE_URL="https://airnewn.atlassian.net/wiki"

          NEW_VERSION=$((PAGE_VERSION + 1))

          # Convert table content to JSON-friendly format
          HTML_CONTENT=$(jq -Rs . < table.html)

          curl -X PUT "$CONFLUENCE_URL/rest/api/content/$PAGE_ID" \
            -u "${{ secrets.CONFLUENCE_USERNAME }}:${{ secrets.CONFLUENCE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "id": "'$PAGE_ID'",
              "type": "page",
              "title": "PR Commits Log",
              "version": { "number": '$NEW_VERSION' },
              "body": {
                "storage": {
                  "value": '$HTML_CONTENT',
                  "representation": "storage"
                }
              }
            }'

      - name: Confirm Confluence Update
        run: echo "‚úÖ Confluence page updated successfully!"
