name: Update Confluence on PR Merge

on:
  pull_request:
    types:
      - closed  # Runs only when a PR is merged
    branches:
      - main  # Change this if your main branch has a different name

jobs:
  update-confluence:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetches full history to get commit logs correctly

      - name: Fetch Commit Details
        run: |
          MODULE_NAME=$(basename $GITHUB_REPOSITORY)  # Extracts repo name
          echo "Module Name: $MODULE_NAME"

          # Start table structure
          echo '<table><tr><th>Module Name</th><th>Commit ID</th><th>Commit Message</th><th>Commit Date & Time</th></tr>' > table.html

          # Fetch commit details from PR range
          git log --pretty=format:"%H|%s|%cd" --date=iso ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > commits.txt

          while IFS='|' read -r COMMIT_ID COMMIT_MSG COMMIT_DATE; do
            echo "Adding commit: $COMMIT_ID - $COMMIT_MSG - $COMMIT_DATE"
            echo "<tr><td>$MODULE_NAME</td><td>$COMMIT_ID</td><td>$COMMIT_MSG</td><td>$COMMIT_DATE</td></tr>" >> table.html
          done < commits.txt

          # End table
          echo '</table>' >> table.html

          # Debug: Show final table content
          echo "Final table content:"
          cat table.html

      - name: Fetch Current Confluence Page Version
        run: |
          RESPONSE=$(curl -s -X GET "$CONFLUENCE_URL/rest/api/content/$PAGE_ID?expand=version" \
            -u "${{ secrets.CONFLUENCE_USERNAME }}:${{ secrets.CONFLUENCE_API_TOKEN }}" \
            -H "Accept: application/json")

          echo "API Response: $RESPONSE"

          PAGE_VERSION=$(echo "$RESPONSE" | jq -r '.version.number')
          
          if [[ "$PAGE_VERSION" == "null" || -z "$PAGE_VERSION" ]]; then
            PAGE_VERSION=1
          else
            PAGE_VERSION=$((PAGE_VERSION + 1))
          fi

          echo "Incremented Page Version: $PAGE_VERSION"

          # Store PAGE_VERSION as an environment variable
          echo "PAGE_VERSION=$PAGE_VERSION" >> $GITHUB_ENV


      - name: Debug JSON Payload
        run: |
          PAGE_ID="98308"
          CONFLUENCE_URL="https://airnewn.atlassian.net/wiki"
          PAGE_VERSION="3"  # Example version, replace dynamically if needed

          JSON_PAYLOAD=$(cat <<EOF
          {
            "id": "$PAGE_ID",
            "type": "page",
            "title": "Your Page Title",
            "space": { "key": "YOUR_SPACE_KEY" },
            "version": { "number": $((PAGE_VERSION + 1)) },
            "body": {
              "storage": {
                "value": "<table><tr><th>Module Name</th><th>Commit ID</th><th>Commit Message</th><th>Commit Date & Time</th></tr><tr><td>TestModule</td><td>1234567</td><td>Fix bug</td><td>2025-04-02</td></tr></table>",
                "representation": "storage"
              }
            }
          }
          EOF
          )

          echo "📝 JSON PAYLOAD:"
          echo "$JSON_PAYLOAD"

      - name: Debug Confluence URL
        run: |
          echo "🔍 Checking Confluence API URL: $CONFLUENCE_URL/rest/api/content/$PAGE_ID"

      - name: Set Variables
        run: |
          echo "CONFLUENCE_URL=https://airnewn.atlassian.net/wiki" >> $GITHUB_ENV
          echo "PAGE_ID=98308" >> $GITHUB_ENV

      - name: Fetch Page Info
        run: |
          curl -s -X GET "$CONFLUENCE_URL/rest/api/content/$PAGE_ID" \
            -u "${{ secrets.CONFLUENCE_USERNAME }}:${{ secrets.CONFLUENCE_API_TOKEN }}" \
            -H "Accept: application/json"

      - name: Use Page Version in Confluence Update
        run: |
          echo "Updating Confluence Page to Version: ${{ env.PAGE_VERSION }}"
          curl -s -X PUT "$CONFLUENCE_URL/rest/api/content/$PAGE_ID" \
            -u "${{ secrets.CONFLUENCE_USERNAME }}:${{ secrets.CONFLUENCE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "id": "'$PAGE_ID'",
              "type": "page",
              "title": "Your Page Title",
              "space": { "key": "YOUR_SPACE_KEY" },
              "version": { "number": '${{ env.PAGE_VERSION }}' },
              "body": {
                "storage": {
                  "value": "<p>Updated Content</p>",
                  "representation": "storage"
                }
              }
            }'




      - name: Confirm Confluence Update
        run: echo "✅ Confluence page updated successfully!"
